{% load cms_tags sekizai_tags %}
<form action="" method="post" class="calc_form {{ instance.tag_class }}" id="calc_form-{{ instance.id }}" style="{{ instance.tag_style }}">{% csrf_token %}
    {% if messages %}
        <div class="alert alert-warning alert-message alert-dismissible">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
            <ul class="messages">
                {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}
    <input class="hidden" type="text" name='comment' value='{{ instance.comment }}'>
    <div class="form-group input-group">
        <div class="input-group-addon">{{ instance.comment }}</div>
        {{ form.comment }}
    </div>
    <hr>
    <div class="plugin_parent">
    {% for plugin in instance.child_plugin_instances %}
        {% render_plugin plugin %}
    {% endfor %}
    </div>
</form>

{# Скрипт затухания сообщений об ошибках #}
{% addtoblock "js" %}<script type="text/javascript" src="{{ STATIC_URL }}jquery/jquery-2.2.4.js"></script>{% endaddtoblock %}
{% addtoblock "js" %}
<script type="text/javascript">
    $(document).ready( function(){
       var hide_delay = 5000;  // starting timeout before first message is hidden
       var hide_next = 800;   // time in mS to wait before hiding next message
       $("#calc_form-{{ instance.id }} .alert-message").slideDown().each( function(index,el) {
          window.setTimeout( function(){
             $(el).slideUp();  // hide the message
          }, hide_delay + hide_next*index);
       });

       var $btn = $('#calc_form-{{ instance.id }} #calc_submit_button').button('loading');
       window.setTimeout(function () {
                $btn.button('reset');
                }, 1000);
    });

    $(function() {
      $('#calc_form-{{ instance.id }}').submit(function(e) {
        var data = {};
        var $form = $(this);
        var $btn = $('#calc_form-{{ instance.id }} #calc_submit_button').button('loading');

        data = $form.serialize();
        $.ajax({
          type: $form.attr('method'),
          url: $form.attr('action'),
          data: data
        }).done(function(receive) {
          $("body").html(receive);
          $btn.button('reset');
        }).fail(function() {
            $("#calc_form-{{ instance.id }}").prepend("<div class='alert alert-error alert-danger' role='alert'><a href='#' class='close' data-dismiss='alert' aria-label='close'>&times;</a>Нет соединения с сервером, повторите попытку.</div>");
            window.setTimeout(function () {
                $btn.button('reset');
                }, 1000);

        });
        e.preventDefault();
      });
    });
</script>
{% endaddtoblock %}
{#TODO: Удалить из шаблона console.log при реализации на сервере#}